---
- import_role:
    name: kubernetes.containerruntime
    tasks_from: check_runtime.yaml

- name: Check for existing kube-config
  stat:
    path: "{{ kube_home }}/.kube/config"
  register: user_kube_config

- name: Copy kubeadm init configuration file to host
  template:
    src: "../templates/{{ kube_init_config_name }}.j2"
    dest: "{{ kube_init_config_path }}"
  run_once: true

- name: Initialize kubernetes cluster
  shell: "kubeadm init --config {{ kube_init_config_path }}"
  become: yes
  args:
    executable: "/bin/bash"
  register: kubeadm_init_output
  when: "(user_kube_config.stat.exists == false)"
  run_once: true

- debug:
    msg: "{{ kubeadm_init_output.stdout }}"
  when: "(user_kube_config.stat.exists == false)"

- name: Assert that kubeadm init was successful
  assert:
    that: "kubeadm_init_output.rc == 0"
    fail_msg: "kubeadm init was not successful"
    success_msg: "kubeadm init was successful"
  when: "(user_kube_config.stat.exists == false)"

- include_tasks: copy_kubeconfig.yaml
- include_tasks: fetch_kubeconfig.yaml
